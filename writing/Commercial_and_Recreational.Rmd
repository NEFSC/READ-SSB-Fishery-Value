---
title: "Commercial and Recreational Value"
author: "Min-Yang Lee"
date: "`r format(Sys.time(), '%B %d, %Y')`" 
output:
  html_document:
    df_print: paged
    keep_md: yes
    fig_caption: yes
params:
  finished_switch:
    value: placeholder
    choices:
    - placeholder
    - finished
  deflate_year:
    value: 2024

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(comment = FALSE)
knitr::opts_chunk$set(error = FALSE)
knitr::opts_chunk$set(message = FALSE)

library(here)
library(tidyverse)
library(data.table)
library(reshape2)
library(ggpubr)
library(kableExtra)
library(glue)
library(survey)
library(fredr)
library(conflicted)
conflicts_prefer(dplyr::filter)
conflicts_prefer(lubridate::year)
conflicts_prefer(dplyr::summarise)
conflicts_prefer(dplyr::arrange)
options(scipen=999)
options(survey.lonely.psu = "certainty")

here::i_am("writing/Commercial_and_Recreational.Rmd")


```

```{r extract_data, eval=FALSE, include=FALSE}

#Some of the data prep takes a long time. 
#Instead of pulling data every time I want to compile this doc, I have split off the code to do so into the following pieces.

# Get GDP implicit price deflators
source(here("R_code", "data_extraction_processing", "extraction","FRED_extraction.R"))


# Get commercial data
source(here("R_code", "data_extraction_processing", "extraction","fmp_value_datapull.R"))

# Get MRIP sites
source(here("R_code", "data_extraction_processing", "extraction","MRIP_sites.R"))

     
# Get MRIP catch and effort data
source(here("R_code", "data_extraction_processing", "extraction","MRIP_Data_Extraction.R"))
```

```{r readin_data, include=FALSE}
vintage_string<-list.files(here("data_folder","main"), pattern=glob2rx("species_area_landings_*Rds"))
vintage_string<-gsub("species_area_landings_","",vintage_string)
vintage_string<-gsub(".Rds","",vintage_string)
vintage_string<-max(vintage_string)

CAMS_revenue<-readRDS(file=here("data_folder", "main", glue("species_area_landings_{vintage_string}.Rds")))
stock_area_definitions<-readRDS(file=here("data_folder", "main", glue("stock_area_definitions_{vintage_string}.Rds")))
fmp_listing<-readRDS(file=here("data_folder", "main", glue("fmp_listing_{vintage_string}.Rds")))

#landings and value for non northeast managed species.
non_NEM_landings<-readRDS(file=here("data_folder","main",glue("Other_species_landings_{vintage_string}.Rds")))


# load in the MRIP site list
site_list<-readRDS(file=here("data_folder","raw",glue("mrip_sites_{vintage_string}.Rds")))
# Read in trip data
Tripdata<-readRDS(file=here("data_folder","raw",glue("rectrip_{vintage_string}.Rds")))

# Read in Deflators
deflators<-readRDS(file=here("data_folder","raw",glue("deflators_{vintage_string}.Rds")))
```

```{r process_deflators, include=FALSE}

deflate_base<-deflators %>%
  filter(year==params$deflate_year)%>%
  pull(value)

# multiply a NOMINAL value by the deflation multiplier to get REAL 'base-year' dollars
deflators<-deflators %>%
  mutate(deflation_multiplier  = deflate_base/value) %>%
  select(year,series_id,deflation_multiplier)

```

# Introduction

This document describes how we assemble Gross Revenues for Commercial and Gross expenditures for Recreational at the stock level.

# Gross Revenues for Commercial

Gross revenues aggregated to the species and statistical area were extracted from CAMS.  We aggregated to the stockarea using a modification of the ``cams_garfo.cfg_statarea_stock`` table.  This does not have all stock definitions in it, fortunately most of the missing ones are Unit stocks.  We used the ``STOCKEFF`` website to look up which species are unit stocks and which have areas.  For stocks not in ``STOCKEFF,`` we used the stock assessment and relevant fishery management documents.

```{r dataclean_commercial}

# Pull in stock area definitions.  Drop out landings from Canada or the 700s.


CAMS_revenue<-CAMS_revenue %>%
  left_join(stock_area_definitions, by=join_by(itis_tsn==itis_tsn, area==area))%>%
  mutate(area=as.numeric(area))%>%
  filter(area<639 & area>=464) %>%
  filter(!area %in% c(466,467,511,552))%>%
  mutate(missing=is.na(area_name2))
# There is still a little slop, A bit of skates that do not match. 
#table(CAMS_revenue$itis_name, CAMS_revenue$missing)

# Some do not have a definition. Classify those as unit stocks
CAMS_revenue<-CAMS_revenue %>%
  mutate(area_name2=if_else(is.na(area_name2),"Unit",area_name2))%>%
  select(-c(common_name, area_name))


# Aggregate landings and value to the stock-year level.
CAMS_revenue<-CAMS_revenue%>%
  group_by(council, itis_name, itis_tsn, area_name2, itis_sci_name, fmp, year) %>%
  summarise(commercial_value=sum(value),
            commercial_landed_pounds=sum(landings)) %>%
  ungroup()


non_NEM_landings<-non_NEM_landings %>%
  select(council, itis_name, itis_tsn, itis_sci_name, fmp, year) %>%
    group_by(council, itis_name, itis_tsn, itis_sci_name, fmp, year) %>%
  summarise(commercial_value=sum(value),
            commercial_landed_pounds=sum(landings)) %>%
  ungroup() %>%
  mutate(area_name2="Unit")

CAMS_revenue<-rbind(CAMS_revenue,non_NEM_landings)
CAMS_revenue<-CAMS_revenue %>%
  arrange(council, itis_name, itis_tsn, itis_sci_name, fmp, year)


```

## Which stocks

Print out a table of stocks by manager. This is just an easy way to make sure we have what we are expecting.


```{r keyfiles}
stock_keyfile<-CAMS_revenue %>%
  select(c(council, fmp, itis_name, area_name2)) %>%
  group_by(council, fmp, itis_name, area_name2) %>% 
    slice(1) %>%
  ungroup() %>%
  arrange(council,fmp, itis_name, area_name2)

ASFMC<-stock_keyfile %>%
  filter(council == "ASMFC" | council=="ASMFC/NEFMC")


MAFMC<-stock_keyfile %>%
  filter(council == "MAFMC" | council=="MAFMC/NEFMC")

NEFMC<-stock_keyfile %>%
  filter(council == "NEFMC" | council=="MAFMC/NEFMC"  | council=="ASMFC/NEFMC")

```

### ASMFC stocks

```{r ASFMC_stocks}
 knitr::kable(ASFMC %>% select(-council), caption='ASMFC stocks',format.args = list(big.mark = ","), digits=1, align=c("l", "l","r") ) 

```
### MAFMC stocks

```{r MAFMC_stocks}
 knitr::kable(MAFMC  %>% select(-council), caption='MAFMC stocks',format.args = list(big.mark = ","), digits=1, align=c("l", "l","r") ) 

```

### NEFMC stocks


```{r NEFMC_stocks}

 knitr::kable(NEFMC  %>% select(-council), caption='NEFMC stocks',format.args = list(big.mark = ","), digits=1, align=c("l", "l","r") ) 

```



# Expenditures for Recreational

Recreational expenditures are computed based on trips and the first target species.  We use the ``RECDBS.MRIP_COD_ALL_SITE_LIST`` table to assign each state-county-intsite to a statistical area. We allocate recreational effort to the stock in the same way we allocate commercial effort (a modified version of ``cams_garfo.cfg_statarea_stock``).


```{r Prepare_sites}

# lower case the columns and keep just the ones I need 
site_list<-site_list %>%
    rename_with(tolower)%>%
  select(intsite,nmfs_stat_area, state_code, county_code)
```

```{r read_and_prepTripdata}
# The trip data is "all" MRIP data, so we need to do a few things before we can compute total effort at the stock-year level
# Subset to our geographic region
# Subset to the trips that target our species.
# Assign statistical areas
# Use statistical areas to assign to stock areas


# fix the var_id
# create a binned mode that aggregates the for-hire together
# keep just some of the columns that I need.
Tripdata <- Tripdata %>% 
  mutate(var_id = ifelse(var_id=="",strat_id,var_id),
         mode_fc = mode_fx,
         mode_fc= ifelse(mode_fc%in%c("5","6"),"4",mode_fc)) %>%
  select(strat_id,
                psu_id,
                id_code,
                st,
                cnty,
                intsite,
                wave,
                mode_fc,
                var_id,
                region, 
                sub_reg,
                wp_int,
                year, 
                intsite,
                tsn1,
                tsn2, 
              prim1_common,
             prim2_common) 

# sort
Tripdata  <- Tripdata %>% 
  arrange(strat_id, psu_id, id_code) 


Tripdata  <- Tripdata %>% 
  filter(year>=2004)

##############################################################
# Keep rows that are among the species that we are interested in.  

# make a vector of the itis names
tsns<-fmp_listing %>%
  pull(itis_tsn)

# Filter on tsn1 in our 'list of species'.
Tripdata  <- Tripdata %>% 
  filter(tsn1 %in% tsns)


# assign to statistical areas
# state, county, and intsite are needed to uniquely join.
Tripdata  <- Tripdata %>% 
  left_join(site_list, by=join_by(st==state_code, cnty==county_code,intsite==intsite))

# Filter for just NC to ME
# Keep the years we want

REC_DATA <- Tripdata %>% 
  filter(sub_reg %in% c(4,5) | st==37) %>%
  filter(year >=2021 & year<=2024) 

# Create the directed trip indicator, convert the mode and Region variables to factors.    
REC_DATA<-REC_DATA %>%  
  mutate(dtrip=1,
         mode_fc=factor(mode_fc,levels=c("3","4","7"),
                        labels=c("Shore","Party_Charter","Private_Rental")),
         Region=factor(sub_reg,levels=c("4","5","6"),
                       labels=c("NE","MA", "NC")))

# Add in the stock area definitions, which area at the itis_tsn and statistical area.
REC_DATA<-REC_DATA %>%
  left_join(stock_area_definitions, by=join_by(tsn1==itis_tsn, nmfs_stat_area==area))

saveRDS(REC_DATA, file=here("data_folder","main",glue("REC_DATA_{params$finished_switch}_{vintage_string}.Rds")))

```

The stock areas from CAMS are a bit messy, it doesn't actually include everything. 

```{r data_clean_stockarea}

#REC_DATA<-readRDS(file=here("data_folder","main",glue("REC_DATA_{params$finished_switch}_{vintage_string}.Rds")))

REC_DATA<-REC_DATA %>%
  mutate(missing=is.na(area_name2))
# look at the missing area_name2
table(REC_DATA$missing, REC_DATA$prim1_common)
#It's not too bad, the only one that has any missing==FALSE and 2 stock areas is Black Sea Bass.
# We can deal with it based on state.
# 
# test<-REC_DATA %>% 
#   filter(missing==TRUE & target_common=="BLACK SEA BASS")
# test2<-REC_DATA %>% 
#   filter(missing==FALSE & target_common=="BLACK SEA BASS")

#Black sea bass
REC_DATA<-REC_DATA %>%
  mutate(area_name2 = case_when(
    tsn1==167687 & st %in% c(9,25,33,44) & is.na(area_name2)~ "NORTH",
    tsn1==167687 & st %in% c(10,24,36,37, 51)  & is.na(area_name2) ~ "SOUTH",
    tsn1==167687 & st ==34 & cnty %in% c(3,13,17,23,39)  & is.na(area_name2) ~ "NORTH",
    tsn1==167687 & st ==34 & cnty %in% c(1,5,9,11,29)  & is.na(area_name2)~ "SOUTH",
    .default = area_name2  )
  )


#Lone red hake
REC_DATA<-REC_DATA %>%
  mutate(area_name2 = case_when(
    tsn1==164730 & st %in% c(10,24,36,37, 51)  & is.na(area_name2) ~ "SOUTHERN",
    .default = area_name2  )
  )
           
REC_DATA<-REC_DATA %>%
  mutate(area_name2 = case_when(
    is.na(area_name2)~ "Unit",
  .default = area_name2  )
)

REC_DATA<-REC_DATA %>%
  mutate(missing=is.na(area_name2))

table(REC_DATA$missing)

```


## Compute Recreational Effort

```{r compute_trips}

# construct the object that describes the survey design.

Effortdesign <- svydesign(
  ids = ~psu_id, 
  strata = ~var_id, # Specify the strata variable
  weights = ~wp_int, # Specify the weight variable
  data = REC_DATA,
  nest=TRUE
)

# Compute total trips targeting a stock by mode. I'm keeping mode because expenditures vary by mode. 
Effortmeans <- svyby(~dtrip, by=~year+tsn1+mode_fc+area_name2,
                     svytotal,
                     design=Effortdesign)

# Round
Effortmeans$dtrip <- ceiling(Effortmeans$dtrip)
Effortmeans$se <- ceiling(Effortmeans$se)

```


```{r compute_rec_expenses}
if (params$finished_switch=="placeholder"){
  cost<-50
} else if  (params$finished_switch=="finished") {
  # This will require a join to the 2022 expenditure survey data. 
}
    
    
Effort_totals<-Effortmeans %>%
  mutate(value=cost*dtrip) %>%
  group_by(year,tsn1,area_name2) %>%
  summarise(recreational_value=sum(value))

```


##  Join

Join the commercial to the recreational data and save

```{r merge_to_commercial}

All_Expenditures<-CAMS_revenue  %>%
  left_join(Effort_totals, by=join_by(year==year, itis_tsn==tsn1, area_name2==area_name2)) %>%
  mutate(recreational_value=if_else(is.na(recreational_value),0,recreational_value))

saveRDS(All_Expenditures, file=here("data_folder","main",glue("All_expenditures_{params$finished_switch}_{vintage_string}.Rds")))


```




