---
title: "Recreational Value"
author: "Min-Yang Lee"
date: "`r format(Sys.time(), '%B %d, %Y')`" 
output:
  html_document:
    df_print: paged
    keep_md: yes
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(comment = FALSE)
knitr::opts_chunk$set(error = FALSE)
knitr::opts_chunk$set(message = FALSE)

library(here)
library(tidyverse)
library(data.table)
library(reshape2)
library(ggpubr)
library(kableExtra)
library(glue)
library(survey)
library(fredr)
library(scales)
library(conflicted)
conflicts_prefer(dplyr::filter)
conflicts_prefer(lubridate::year)
conflicts_prefer(dplyr::summarise)
conflicts_prefer(dplyr::arrange)
options(scipen=999)
options(survey.lonely.psu = "certainty")

here::i_am("writing/Recreational_Value.Rmd")


```

```{r extract_data, eval=FALSE, include=FALSE}

#Some of the data prep takes a long time. 
#Instead of pulling data every time I want to compile this doc, I have split off the code to do so into the following pieces.

# Get MRIP sites
source(here("R_code", "data_extraction_processing", "extraction","MRIP_sites.R"))

     
# Get MRIP catch and effort data
source(here("R_code", "data_extraction_processing", "extraction","MRIP_Data_Extraction.R"))
```

```{r readin_data, include=FALSE}
vintage_string<-list.files(here("data_folder","main"), pattern=glob2rx("species_area_landings_*Rds"))
vintage_string<-gsub("species_area_landings_","",vintage_string)
vintage_string<-gsub(".Rds","",vintage_string)
vintage_string<-max(vintage_string)

stock_area_definitions<-readRDS(file=here("data_folder", "main", glue("stock_area_definitions_{vintage_string}.Rds")))
stock_area_definitions<-stock_area_definitions %>%
  rename(stockarea=area_name2)
fmp_listing<-readRDS(file=here("data_folder", "main", glue("fmp_listing_{vintage_string}.Rds")))

# Read in Stock keyfile												  
stock_keyfile<-readRDS(file=here("data_folder", "main", glue("stock_keyfile_{vintage_string}.Rds")))
# Read in Deflators

#Read in rec data
rec_vintage_string<-list.files(here("data_folder","raw"), pattern=glob2rx("mrip_sites_*Rds"))
rec_vintage_string<-gsub("mrip_sites_","",rec_vintage_string)
rec_vintage_string<-gsub(".Rds","",rec_vintage_string)
rec_vintage_string<-max(rec_vintage_string)
# load in the MRIP site list
site_list<-readRDS(file=here("data_folder","raw",glue("mrip_sites_{rec_vintage_string}.Rds")))
# Read in trip data
Tripdata<-readRDS(file=here("data_folder","raw",glue("rectrip_{rec_vintage_string}.Rds")))

# Read in Trip Expenditure data
impact.data0.2022=read.csv(here("data_folder","external","Trip_Exp_Imp_2022survey.csv")) %>%
  mutate(State=trimws(State))%>%
  rename(mode=MODE, 
         state=State)


# Read in Value Add multipliers
impact.data0.2022.1=read.csv(here("data_folder","external","trip_impacts_multipliers_2022.csv")) %>%
  rename(mode = Mode) %>%
  filter(mode != "Total Trip",state3=="United States") %>%
  select(mode,m_va22)


# Read in state fips codes and names
#url <- "https://www2.census.gov/geo/docs/reference/codes2020/national_state2020.txt"

states <- read_delim(here("data_folder","external","national_state2020.txt"), 
                         delim = "|", 
                         col_types = cols(.default = "c"),  # read all as character initially
                         show_col_types = FALSE)
states<- states %>%
  rename(state=STATE_NAME,
         stateabb=STATE,
         statefp=STATEFP)%>%
  select(stateabb,statefp,state)%>%
  mutate(statefp_string=statefp)%>%
  mutate(statefp=as.numeric(statefp))

```

# Introduction

This document describes how we assemble Gross Expenditures for Recreational at the stock level.

## Which stocks do I have

Print out a table of stocks by manager. This is just an easy way to make sure we have what we are expecting.


```{r keyfiles}
ASFMC<-stock_keyfile %>%
  filter(council == "ASMFC" | council=="ASMFC/NEFMC")


MAFMC<-stock_keyfile %>%
  filter(council == "MAFMC" | council=="MAFMC/NEFMC")

NEFMC<-stock_keyfile %>%
  filter(council == "NEFMC" | council=="MAFMC/NEFMC"  | council=="ASMFC/NEFMC")

Non_Managed<-stock_keyfile %>%
  filter(is.na(council))

out_of_geog<-fmp_listing %>%
  filter(fmp  %in% c("SERO FMP","Highly Migratory Species"))
```

### ASMFC stocks

```{r ASFMC_stocks}
 knitr::kable(ASFMC %>% select(-c(council, itis_tsn)), caption='ASMFC stocks',format.args = list(big.mark = ","), digits=1, align=c("l", "l","r") ) 

```
### MAFMC stocks

```{r MAFMC_stocks}
 knitr::kable(MAFMC  %>% select(-c(council, itis_tsn)), caption='MAFMC stocks',format.args = list(big.mark = ","), digits=1, align=c("l", "l","r") ) 

```

### NEFMC stocks


```{r NEFMC_stocks}

 knitr::kable(NEFMC  %>% select(-c(council, itis_tsn)), caption='NEFMC stocks',format.args = list(big.mark = ","), digits=1, align=c("l", "l","r") ) 

```

### HMS and SERO 
HMS, and SERO. Southeast Science center is on this.


```{r HMS_SERO}
 knitr::kable(out_of_geog  %>% select(c(fmp, itis_name)), caption='HMS and SERO stocks',format.args = list(big.mark = ","), digits=1, align=c("l", "l","r") ) 

```
### Non-Managed

These are a mixed of state managed stocks


```{r Non-Managed}
 knitr::kable(Non_Managed  %>% select(-c(council, itis_tsn)), caption='Non-Northest Region stocks',format.args = list(big.mark = ","), digits=1, align=c("l", "l","r") ) 

```


# Expenditures for Recreational

Recreational expenditures are computed based on trips and the first target species.  We use the ``RECDBS.MRIP_COD_ALL_SITE_LIST`` table to assign each state-county-intsite to a three digit statistical area. We use a lightly modified version of ``cams_garfo.cfg_statarea_stock`` to allocate recreational effort to the stock level in the same way we allocate commercial effort.


## Process Expenditure data 

Finagle the names of certain columns.  Join the expenditure data to the multipliers data on mode. Join the result to the state fips codes, on state.  Subset to the states in the Northeast Region, round, and

```{r table_of_expenditures}

impact.data0.2022.mod <- impact.data0.2022 %>%
  left_join(impact.data0.2022.1, by = join_by(mode==mode))

impact.data0.2022.mod <- impact.data0.2022.mod %>%
  left_join(states,by = join_by(state==state))%>%
  arrange(statefp, stateabb,state,mode)
  
mid_atlantic<-c("RI","CT","NY","NJ","PA","DE","DC","VA","MD","NC")
new_england<-c("ME","NH","MA","RI","VT")
my_states<-c(new_england,mid_atlantic)

filtered_states<-impact.data0.2022.mod %>% filter(stateabb %in% unique(my_states)) %>%
  mutate(adult_per=percent(adult_per,accuracy=1),
         total_avg=dollar(total_avg)) %>%
  select(state,mode,total_avg,adult_per,m_va22)

kbl(filtered_states,digits=2,
      col.names = c("State","Mode","Expenditure/Trip","Adult Share","Value-Added Multiplier")) %>% kable_classic()



```


## Prepare site data

Keep just some of the site list data.  There are some MRIP sites that are not in the the ``RECDBS.MRIP_COD_ALL_SITE_LIST`` table. For these sites, we will just assign statistical area based on the most frequent statistical area in that county. Nearly all sites with the same county have the same statistical area.

```{r Prepare_sites}

# lower case the columns and keep just the ones I need 
site_list<-site_list %>%
    rename_with(tolower)%>%
  select(intsite,nmfs_stat_area, state_code, county_code)


county_list<-site_list %>%
  group_by(state_code, county_code) %>%
  count(nmfs_stat_area)%>%
  arrange(state_code, county_code, n) %>%
  select(state_code,county_code,nmfs_stat_area) %>%
  rename(nmfs_stat_areaC=nmfs_stat_area)

```

## Prepare MRIP trip data

The trip data is "all" MRIP data, so we need to do a few things before we can compute total effort at the stock-year level. We:

* Subset to our geographic region (region 4, region 5 plus North carolina). 
* Bin the modes together.
* Drop some columns.
* Subset to the trips that target our species and bring in the Council/FMP. 


```{r read_and_prepTripdata}

# 2018-2024 or later
Tripdata  <- Tripdata %>% 
  filter(year>=2018 & year<=2024) 

# Northeast, Mid-Atlantic, or North Carolina
Tripdata <- Tripdata %>% 
  filter(sub_reg %in% c(4,5) | st==37) 

# fix the var_id
# create a binned mode that aggregates the for-hire together
# keep just some of the columns that I need.
Tripdata <- Tripdata %>% 
  mutate(var_id = ifelse(var_id=="",strat_id,var_id),
         mode_fc = mode_fx,
         mode_fc= ifelse(mode_fc%in%c("5","6"),"4",mode_fc)) %>% # 3=shore, 4=for-hire, 7=private boat
  select(strat_id,
                psu_id,
                id_code,
                st,
                cnty,
                intsite,
                wave,
                mode_fc,
                var_id,
                region, 
                sub_reg,
                wp_int,
                year, 
                intsite,
                tsn1,
                tsn2, 
              prim1_common,
             prim2_common) 

# sort
Tripdata  <- Tripdata %>% 
  arrange(strat_id, psu_id, id_code) 




##############################################################
# Keep rows that are among the species that we are interested in.  

# make a vector of the itis names
tsns<-fmp_listing %>%
  select(itis_tsn,fmp,council) %>%
  mutate(in_fmp_keyfile=1)

# Inner join to the keyfile to keep just the trips that are in the fmp listing 
Tripdata  <- Tripdata %>% 
  inner_join(tsns, by=join_by(tsn1==itis_tsn))

```

## Assign trips to stock areas

* Assign statistical areas, based on intsite, filling in mismatches with a county-level statistical area.
* Join to the stock definitions


```{r join_to_statistical}

# assign to statistical areas
# state, county, and intsite are needed to uniquely join.
Tripdata  <- Tripdata %>% 
  left_join(site_list, by=join_by(st==state_code, cnty==county_code,intsite==intsite))

# use the most prevalent stat area by county in case there are missing intsites
Tripdata  <- Tripdata %>% 
  left_join(county_list, by=join_by(st==state_code, cnty==county_code))

# merge update
Tripdata<-Tripdata %>%
  mutate(nmfs_stat_area=if_else(is.na(nmfs_stat_area), nmfs_stat_areaC,nmfs_stat_area)) %>%
  select(-nmfs_stat_areaC)
```



```{r join_to_stock_definitions}

# Add in the stock area definitions, which area at the itis_tsn and statistical area.
REC_DATA<-Tripdata %>%
  left_join(stock_area_definitions, by=join_by(tsn1==itis_tsn, nmfs_stat_area==area))


# Just mark anything that is not in our area as "Unit"
# test2<-REC_DATA %>%
#   filter(fmp %in% "No Federal FMP")
# 
# table(test2$prim1_common)


# Fill in missing stockareas for things that are not NER managed with "Unit"
REC_DATA<-REC_DATA %>%
   mutate(stockarea = case_when(
          fmp %in% "No Federal FMP" & is.na(stockarea)~ "Unit",
          .default=stockarea)
 )


# test3<-REC_DATA %>%
#    filter(is.na(stockarea)) %>%
#   group_by(prim1_common) %>%
#   slice(1) %>%
#   pull(prim1_common)
# test3<-REC_DATA %>%
#    filter(is.na(stockarea) & prim1_common=="WINDOWPANE") %>%
#   group_by(prim1_common) 
# 
# 

```

## Manual data cleaning is inevitable

The table that maps ``intsite`` to ``nmfs_stat_area`` was designed for cod.  There are some intsites in the south that doe not appear in this table. Fortunately, most mis-matches are easy to resolve.

```{r data_clean_stockarea}


REC_DATA<-REC_DATA %>%
  mutate(missing=is.na(stockarea))
# look at the missing stockarea
table(REC_DATA$prim1_common,REC_DATA$missing)
#It's not too bad, the only one that has any missing==FALSE and 2 stock areas is Black Sea Bass.
# We can deal with it based on state.
# 
# test<-REC_DATA %>% 
#   filter(missing==TRUE & target_common=="BLACK SEA BASS")
# test2<-REC_DATA %>% 
#   filter(missing==FALSE & target_common=="BLACK SEA BASS")

#Black sea bass
REC_DATA<-REC_DATA %>%
  mutate(stockarea = case_when(
    tsn1==167687 & st %in% c(9,25,33,44) & is.na(stockarea)~ "NORTH",
    tsn1==167687 & st %in% c(10,24,36,37, 51)  & is.na(stockarea) ~ "SOUTH",
    tsn1==167687 & st ==34 & cnty %in% c(3,13,17,23,39)  & is.na(stockarea) ~ "NORTH",
    tsn1==167687 & st ==34 & cnty %in% c(1,5,9,11,29)  & is.na(stockarea)~ "SOUTH",
    tsn1==172746 & st ==37 & is.na(stockarea)~ "SNEMA",

    .default = stockarea  )
  )

# Lone Windowpane
REC_DATA<-REC_DATA %>%
  mutate(stockarea = case_when(
    tsn1==172746 & st ==37 & is.na(stockarea)~ "SNEMA",
    .default = stockarea  )
  )


#Lone red hake
REC_DATA<-REC_DATA %>%
  mutate(stockarea = case_when(
    tsn1==164730 & st %in% c(10,24,36,37, 51)  & is.na(stockarea) ~ "SOUTHERN",
    .default = stockarea  )
  )



# Random Acadian Redfish, which is probably Red Drum 
REC_DATA<-REC_DATA %>%
  mutate(stockarea = case_when(
    tsn1==166774 & st %in% c(37)  & is.na(stockarea) ~ "Unit",
    .default = stockarea  )
  )

# Fill in with "unit" for rows where there is no stockarea.     
REC_DATA<-REC_DATA %>%
  mutate(stockarea = case_when(
    is.na(stockarea)~ "Unit",
  .default = stockarea  )
)

REC_DATA<-REC_DATA %>%
  mutate(missing=is.na(stockarea))

# A species cannot be "Unit" and something else.  
test3<-REC_DATA %>%
    mutate(check1 = case_when(
    stockarea=="Unit"~  "Unit",
  .default = "Other"  ) 
    ) %>%
  group_by(prim1_common,check1) %>%
  summarise(count=n()) 

problems<-test3 %>%
  group_by(prim1_common) %>%
  summarise(count=n()) %>%
  filter(count>1)

stopifnot(nrow(problems)==0)
saveRDS(REC_DATA, file=here("data_folder","main",glue("REC_DATA_{vintage_string}.Rds")))


```

That was the last data cleaning step.


## Compute Recreational Effort

This step computes an yearly estimate of trips by mode that target the stock defined by ``tsn`` and ``stockarea.``  We need mode because expenditures vary by mode.

```{r compute_trips}
# Create the directed trip indicator, convert the mode to a factor that matches the expenditure survey. 
# Convert and Region variables to factors.    
REC_DATA<-REC_DATA %>%  
  mutate(dtrip=1,
         mode_fc=factor(mode_fc,levels=c("3","4","7"),
                        labels=c("Shore","For-Hire","Private Boat")),
         Region=factor(sub_reg,levels=c("4","5","6"),
                       labels=c("NE","MA", "NC")))



# construct the object that describes the survey design.

Effortdesign <- svydesign(
  ids = ~psu_id, 
  strata = ~var_id, # Specify the strata variable
  weights = ~wp_int, # Specify the weight variable
  data = REC_DATA,
  nest=TRUE
)

# Compute total trips targeting a stock by mode. I'm keeping mode because expenditures vary by mode. 
Effortmeans <- svyby(~dtrip, by=~year+st+tsn1+mode_fc+stockarea,
                     svytotal,
                     design=Effortdesign)

# Round
Effortmeans$dtrip <- ceiling(Effortmeans$dtrip)
Effortmeans$se <- ceiling(Effortmeans$se)

Effortmeans<-Effortmeans %>%
  mutate(mode_str= as.character(mode_fc))

```

## Calculating Value-Added

The formula for calculating the value-added, $v_{i,t,s}$, for state, $i$, mode, $t$, and species, $s$, combination is as follows:

$$
v_{i,t,s} = D_{i,t,s} * a_{i,t} * e_{i,t} * m_{t}
$$

where $D_{i,t,s}$ is the total target trips, $a_{i,t}$ is the share of adults, $e_{i,t}$ is the expenditure per trip, and $m_{i}$ is the value-added multiplier. To implement this formula we combine the trips and the expenditure impact data and perform the calculations. 


```{r compute_rec_expenses}
impact.data0 <- Effortmeans %>%
  left_join(impact.data0.2022.mod,by = join_by(st==statefp, mode_str==mode)) %>%
  mutate(
    # Multiply total number of trips by the adult percentage
    AdultTrips_maxyr = dtrip * adult_per ,
   
    # Multiply adult trips by average expenditures to get total expenditures
    TotalExpenditures_2022 = AdultTrips_maxyr * total_avg,
   
    # Multiply total expenditures by the multipliers to get the impacts
    ValueAdded_maxyr = m_va22 * TotalExpenditures_2022
    )
}
saveRDS(impact.data0, file=here("data_folder","main",glue("impact.data_{vintage_string}.Rds")))

```


## Format the recreational data.
    
```{r save}	
  # Compute value
Recreational_Expenditures<-impact.data0 %>%
  group_by(year,tsn1,stockarea) %>%
  summarise(ValueAdded_maxyr=sum(ValueAdded_maxyr))

# Join to the 'stock' information, which contains info on the manager and des
Recreational_Expenditures<-Recreational_Expenditures %>%
  rename(itis_tsn=tsn1) %>%
  left_join(fmp_listing, by=join_by(itis_tsn==itis_tsn)) %>%
  relocate(council, fmp, itis_tsn, itis_sci_name, itis_name, stockarea)%>%
  arrange(council, fmp, itis_name,stockarea, year) %>%
  rename(manager=council) %>%
  select(-nespp3)

Recreational_Expenditures<-Recreational_Expenditures %>%
  mutate(ValueAdded_maxyr=dollar(ValueAdded_maxyr)) 

saveRDS(Recreational_Expenditures, file=here("data_folder","main",glue("Recreational_Expenditures_{rec_vintage_string}.Rds")))

write.csv(x = Recreational_Expenditures, file=here("data_folder","main",glue("Recreational_Expenditures_{rec_vintage_string}.csv")))

```



